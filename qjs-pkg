#!/bin/bash

PACKAGE_NAME="quickjs-cffi"
PACKAGE_VER="0.1.0"

function prepare () {
    # args
    local ENV_PATH=$1
    local CACHE_PACKAGE_PATH=$2

    # rm if existing
    local CACHE_QUICKJS_FFI_PATH=$ENV_PATH/$CACHE_PACKAGE_PATH/quickjs-ffi

    if [ -d $CACHE_QUICKJS_FFI_PATH ]; then
        rm -rf CACHE_QUICKJS_FFI_PATH
    fi

    # clone
    git clone git@github.com:shajunxing/quickjs-ffi.git $CACHE_QUICKJS_FFI_PATH
    cp patched-quickjs-ffi-Makefile $CACHE_QUICKJS_FFI_PATH/Makefile
    echo prepare $PACKAGE_NAME $PACKAGE_VER
}

function build () {
    # args
    local ENV_PATH=$1
    local CACHE_PACKAGE_PATH=$2
    
    # build
    local CACHE_QUICKJS_FFI_PATH=$ENV_PATH/$CACHE_PACKAGE_PATH/quickjs-ffi
    cd $CACHE_QUICKJS_FFI_PATH
    make

    echo build $PACKAGE_NAME $PACKAGE_VER
}

function install () {
    # args
    local ENV_PATH=$1
    local CACHE_PACKAGE_PATH=$2
    local LOCAL_PACKAGE_PATH=$3
    
    # copy
    local CACHE_QUICKJS_FFI_PATH=$ENV_PATH/$CACHE_PACKAGE_PATH/quickjs-ffi
    # mkdir -p $ENV_PATH/$LOCAL_PACKAGE_PATH
    cp $CACHE_QUICKJS_FFI_PATH/quickjs-ffi.js $ENV_PATH/$LOCAL_PACKAGE_PATH/quickjs-ffi.js
    cp $CACHE_QUICKJS_FFI_PATH/quickjs-ffi.so $ENV_PATH/$LOCAL_PACKAGE_PATH/quickjs-ffi.so

    echo install $PACKAGE_NAME $PACKAGE_VER
}

function uninstall () {
    # args
    local ENV_PATH=$1
    local CACHE_PACKAGE_PATH=$2
    local LOCAL_PACKAGE_PATH=$3

    # remove
    # local CACHE_QUICKJS_FFI_PATH=$ENV_PATH/$CACHE_PACKAGE_PATH/quickjs-ffi
    # rm -rf $ENV_PATH/CACHE_PACKAGE_PATH
    # rm -rf $ENV_PATH/$LOCAL_PACKAGE_PATH

    echo uninstall $PACKAGE_NAME $PACKAGE_VER
}

# dispatch function with args without $0 and $1
echo $($1 ${@:2})
